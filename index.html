<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VaultTracker – Level 1: $1,000 Reserve</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: var(--font-body, "Inter", "Segoe UI", sans-serif);
    }

    :root {
      --accent: #39ff14;
      --accent-strong: rgba(57, 255, 20, 0.85);
      --accent-soft: rgba(57, 255, 20, 0.4);
      --bg-deep: #020204;
      --bg-panel: rgba(10, 14, 24, 0.88);
      --bg-panel-strong: rgba(14, 18, 30, 0.94);
      --text-primary: #ecffef;
      --text-secondary: rgba(148, 255, 198, 0.9);
      --text-muted: rgba(116, 244, 174, 0.6);
      --surface-border: rgba(57, 255, 20, 0.18);
      --surface-outline: rgba(57, 255, 20, 0.08);
      --glow: 0 0 26px rgba(57, 255, 20, 0.45);
      --font-display: "Orbitron", "Inter", "Segoe UI", sans-serif;
      --font-body: "Inter", "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(120% 120% at 50% -10%, rgba(57, 255, 20, 0.25), rgba(57, 255, 20, 0) 55%), var(--bg-deep);
      color: var(--text-primary);
      padding: 32px 24px;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body::before {
      content: "";
      position: fixed;
      inset: -40%;
      background:
        radial-gradient(circle at 20% 20%, rgba(57, 255, 20, 0.18), transparent 55%),
        radial-gradient(circle at 78% 12%, rgba(57, 255, 20, 0.22), transparent 52%),
        radial-gradient(circle at 50% 85%, rgba(57, 255, 20, 0.16), transparent 58%);
      filter: blur(60px);
      opacity: 0.9;
      pointer-events: none;
      z-index: 0;
      transform: translateZ(0);
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(180deg, rgba(57, 255, 20, 0.08) 0%, rgba(57, 255, 20, 0.02) 35%, transparent 100%),
        repeating-linear-gradient(90deg, rgba(57, 255, 20, 0.08) 0, rgba(57, 255, 20, 0.08) 1px, transparent 1px, transparent 120px);
      opacity: 0.35;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: 1;
    }

    .app {
      width: 100%;
      max-width: 820px;
      position: relative;
      z-index: 3;
    }

    .bitcoin-rain {
      position: fixed;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 2;
    }

    .bitcoin-rain span {
      position: absolute;
      top: -12vh;
      left: calc(var(--x) * 1%);
      width: clamp(26px, 3vw, 54px);
      height: clamp(26px, 3vw, 54px);
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff3b9 0%, #f9a932 40%, #f7931a 65%, #a85c0f 100%);
      box-shadow: 0 0 22px rgba(247, 147, 26, 0.55);
      filter: drop-shadow(0 0 12px rgba(247, 147, 26, 0.35));
      animation: fall calc(11s + var(--i) * 0.6s) linear infinite;
      animation-delay: calc(var(--i) * -0.75s);
      opacity: 0.85;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate3d(0, 0, 0) rotate(0deg);
    }

    .bitcoin-rain span::after {
      content: "₿";
      font-size: clamp(14px, 1.7vw, 28px);
      font-weight: 700;
      color: #290d00;
      text-shadow: 0 0 6px rgba(255, 243, 185, 0.7);
    }

    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @keyframes fall {
      0% {
        transform: translate3d(0, -140%, 0) rotate(0deg) scale(0.95);
        opacity: 0;
      }
      10% {
        opacity: 0.9;
      }
      50% {
        transform: translate3d(calc((var(--x) - 50) * 0.12rem), 60vh, 0) rotate(180deg) scale(1.05);
      }
      100% {
        transform: translate3d(calc((var(--x) - 50) * 0.25rem), 120vh, 0) rotate(360deg) scale(0.9);
        opacity: 0;
      }
    }

    /* HEADER */
    .header {
      margin-bottom: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: var(--bg-panel-strong);
      border: 1px solid var(--surface-border);
      border-radius: 20px;
      padding: 20px 24px;
      box-shadow: var(--glow);
      backdrop-filter: blur(18px);
    }

    .header-left {
      text-align: left;
    }

    .header-title {
      font-size: 1.8rem;
      font-weight: 600;
      font-family: var(--font-display);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(57, 255, 20, 0.55);
    }

    .header-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .header-right {
      text-align: right;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .wallet-row {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .wallet-label {
      color: var(--text-muted);
    }

    .wallet-address,
    .wallet-balance,
    .network-status {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .network-status.ok {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(57, 255, 20, 0.5);
    }

    .network-status.warn {
      color: #ff7849;
    }

    .wallet-actions {
      display: flex;
      gap: 6px;
    }

    /* CARD */
    .card {
      background: var(--bg-panel);
      border-radius: 22px;
      padding: 24px 26px 32px;
      box-shadow: var(--glow);
      border: 1px solid var(--surface-border);
      backdrop-filter: blur(14px);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .leaderboard-section {
      margin-top: 32px;
      background: rgba(0, 0, 0, 0.35);
      border-radius: 18px;
      border: 1px solid #1f2937;
      padding: 18px 20px;
      box-shadow: 0 0 24px rgba(0, 255, 0, 0.25);
    }

    .leaderboard-header h2 {
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #a7f3d0;
      margin-bottom: 4px;
    }

    .leaderboard-header p {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-bottom: 12px;
    }

    .leaderboard-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    #leaderboardWalletInput {
      flex: 1;
      min-width: 220px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    .leaderboard-table-wrapper {
      overflow-x: auto;
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .leaderboard-table th,
    .leaderboard-table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    .leaderboard-table th {
      font-weight: 600;
      color: #9ca3af;
    }

    .leaderboard-row-self {
      background: rgba(34, 197, 94, 0.08);
    }

    .leaderboard-rank-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #4ade80;
      color: #bbf7d0;
    }

    @media (max-width: 640px) {
      .leaderboard-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    .chart-section {
      margin-top: 40px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid #1f2937;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.25);
      backdrop-filter: blur(14px);
    }

    .chart-section .tradingview-widget-container {
      width: 100%;
    }

    .chart-section #tradingview_chart {
      width: 100% !important;
      min-height: 340px;
    }

    .ai-section {
      margin-top: 36px;
      background: rgba(4, 8, 16, 0.86);
      border: 1px solid rgba(57, 255, 20, 0.22);
      border-radius: 22px;
      padding: 24px;
      box-shadow: 0 0 34px rgba(57, 255, 20, 0.28);
      backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .ai-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ai-title {
      font-family: var(--font-display);
      font-size: 1.2rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      text-shadow: 0 0 16px rgba(57, 255, 20, 0.45);
    }

    .ai-description {
      font-size: 0.85rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .ai-chat-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .ai-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: min(380px, 55vh);
      overflow-y: auto;
      padding-right: 6px;
      scroll-behavior: smooth;
    }

    .ai-message {
      display: inline-flex;
      max-width: 100%;
      align-self: flex-start;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(10, 16, 26, 0.92);
      border: 1px solid rgba(57, 255, 20, 0.18);
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.16);
      font-size: 0.85rem;
      line-height: 1.55;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    .ai-message.user {
      align-self: flex-end;
      background: rgba(57, 255, 20, 0.12);
      border-color: rgba(57, 255, 20, 0.32);
      color: var(--text-primary);
      box-shadow: 0 0 22px rgba(57, 255, 20, 0.2);
    }

    .ai-meta {
      font-size: 0.7rem;
      color: rgba(148, 255, 198, 0.5);
    }

    .ai-form {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .ai-input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(57, 255, 20, 0.24);
      background: rgba(5, 10, 18, 0.92);
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .ai-input:focus {
      outline: none;
      border-color: rgba(57, 255, 20, 0.55);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.35);
    }

    .ai-submit {
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid rgba(57, 255, 20, 0.4);
      background: linear-gradient(135deg, rgba(57, 255, 20, 0.9), rgba(57, 255, 20, 0.35));
      color: #041007;
      font-family: var(--font-display);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .ai-submit:hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 0 24px rgba(57, 255, 20, 0.35);
    }

    .ai-submit[disabled] {
      cursor: wait;
      opacity: 0.7;
    }

    .ai-hint {
      font-size: 0.75rem;
      color: rgba(148, 255, 198, 0.58);
      line-height: 1.45;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(57, 255, 20, 0.12) 0%, rgba(57, 255, 20, 0) 45%);
      opacity: 0.8;
      pointer-events: none;
      z-index: 0;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    .stat-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .stat-value {
      font-weight: 600;
      font-size: 1.15rem;
      color: var(--text-secondary);
      text-shadow: 0 0 10px rgba(57, 255, 20, 0.35);
      font-family: var(--font-display);
      letter-spacing: 0.04em;
    }

    .rank-menu {
      position: relative;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
      z-index: 4;
    }

    .rank-menu-button {
      min-width: 0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: var(--font-display);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.28);
    }

    .rank-menu-button::after {
      content: "▾";
      font-size: 0.75rem;
      color: var(--accent);
    }

    .rank-menu-options {
      position: absolute;
      top: calc(100% + 10px);
      right: 0;
      width: min(280px, 88vw);
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border-radius: 18px;
      border: 1px solid var(--surface-border);
      background: var(--bg-panel-strong);
      box-shadow: 0 0 28px rgba(57, 255, 20, 0.4);
      backdrop-filter: blur(18px);
    }

    .rank-menu-options.open {
      display: flex;
    }

    .rank-menu-option {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 0.82rem;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(57, 255, 20, 0.05);
      transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
    }

    .rank-menu-option span {
      font-family: var(--font-display);
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .rank-menu-option:hover {
      border-color: rgba(57, 255, 20, 0.4);
      background: rgba(57, 255, 20, 0.16);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.26);
      color: var(--text-primary);
    }

    .rank-menu-option.active {
      border-color: rgba(57, 255, 20, 0.6);
      background: rgba(57, 255, 20, 0.22);
      box-shadow: 0 0 26px rgba(57, 255, 20, 0.4);
      color: var(--text-primary);
    }

    /* PROGRESS BAR */
    .progress-wrapper {
      margin-bottom: 20px;
    }

    .progress-track {
      width: 100%;
      height: 18px;
      background: rgba(57, 255, 20, 0.08);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--surface-border);
      box-shadow: inset 0 0 18px rgba(57, 255, 20, 0.28);
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(57, 255, 20, 0.95), rgba(57, 255, 20, 0.4));
      transition: width 0.3s ease-out;
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.65);
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-family: var(--font-display);
    }

    /* MILESTONES */
    .milestones {
      margin-bottom: 16px;
    }

    .milestones-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
      font-family: var(--font-display);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
    }

    .milestone-list {
      list-style: none;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .milestone-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--surface-outline);
      background: rgba(57, 255, 20, 0.05);
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .milestone-item:hover {
      border-color: rgba(57, 255, 20, 0.3);
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.2);
    }

    .milestone-item span.check {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid var(--surface-border);
      font-size: 0.75rem;
      box-shadow: 0 0 12px rgba(57, 255, 20, 0.2);
    }

    .milestone-item.complete {
      color: var(--accent);
      text-shadow: 0 0 8px rgba(57, 255, 20, 0.45);
      border-color: rgba(57, 255, 20, 0.45);
      background: rgba(57, 255, 20, 0.12);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.32);
    }

    .milestone-item.complete span.check {
      background: var(--accent);
      color: #012b0f;
      border-color: transparent;
    }

    /* BUTTONS */
    button {
      cursor: pointer;
      border: 1px solid var(--surface-border);
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      background: rgba(57, 255, 20, 0.08);
      color: var(--text-primary);
      transition: transform 0.08s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      box-shadow: 0 0 14px rgba(57, 255, 20, 0.15);
    }

    button:hover {
      background: rgba(57, 255, 20, 0.18);
      border-color: rgba(57, 255, 20, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.35);
    }

    .button-accent {
      background: linear-gradient(120deg, rgba(57, 255, 20, 0.95), rgba(57, 255, 20, 0.4));
      color: #021b0c;
      font-weight: 600;
      border-color: transparent;
      box-shadow: 0 0 24px rgba(57, 255, 20, 0.55);
    }

    .button-accent:hover {
      background: linear-gradient(120deg, rgba(57, 255, 20, 1), rgba(57, 255, 20, 0.65));
      box-shadow: 0 0 34px rgba(57, 255, 20, 0.7);
    }

    .button-outline {
      border: 1px solid rgba(57, 255, 20, 0.35);
      background: rgba(57, 255, 20, 0.06);
      padding-inline: 14px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .button-outline:hover {
      background: rgba(57, 255, 20, 0.22);
      color: var(--bg-deep);
    }

    .hint {
      font-size: 0.75rem;
      color: rgba(148, 255, 198, 0.55);
      margin-top: 4px;
    }

    footer.footer {
      margin-top: 14px;
      font-size: 0.7rem;
      color: rgba(148, 255, 198, 0.38);
      text-align: center;
    }

    @media (max-width: 760px) {
      body {
        padding: 24px 16px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        padding: 18px;
      }

      .header-right {
        align-self: stretch;
        text-align: left;
        align-items: flex-start;
      }

      .wallet-row {
        align-items: flex-start;
      }

      .card {
        padding: 20px 18px 26px;
      }

      .chart-section {
        margin-top: 28px;
        padding: 16px;
      }

      .chart-section #tradingview_chart {
        height: 380px !important;
      }

      .ai-section {
        padding: 18px;
        gap: 16px;
      }

      .ai-messages {
        max-height: 320px;
      }

      .ai-submit {
        padding: 12px 16px;
      }
    }

    .wallet-modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 2, 4, 0.92);
      backdrop-filter: blur(18px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
      transition: opacity 0.2s ease;
      opacity: 0;
    }

    .wallet-modal.open {
      display: flex;
      opacity: 1;
    }

    .wallet-modal-content {
      width: min(420px, 100%);
      background: radial-gradient(circle at 10% 10%, rgba(57, 255, 20, 0.12), transparent 65%), var(--bg-panel-strong);
      border: 1px solid var(--surface-border);
      border-radius: 26px;
      position: relative;
      padding: 28px 24px 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
      text-align: center;
    }

    .wallet-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(57, 255, 20, 0.18);
      border: 1px solid var(--surface-border);
      border-radius: 999px;
      color: var(--text-primary);
      width: 34px;
      height: 34px;
      font-size: 1.2rem;
      line-height: 1;
      cursor: pointer;
      box-shadow: var(--glow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .wallet-modal-close:hover {
      transform: scale(1.05);
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.5);
    }

    .wallet-modal-title {
      font-family: var(--font-display);
      font-size: 1.4rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .wallet-modal-subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 22px;
    }

    .wallet-modal-footer {
      margin-top: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .mobile-wallet-selector {
      display: grid;
      gap: 14px;
    }

    .wallet-btn {
      border: 1px solid var(--surface-border);
      border-radius: 18px;
      padding: 14px 18px;
      font-size: 1.05rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      background: linear-gradient(135deg, rgba(57, 255, 20, 0.2), rgba(57, 255, 20, 0.05));
      color: var(--text-primary);
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.24);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .wallet-btn:hover,
    .wallet-btn:focus {
      transform: translateY(-2px);
      background: linear-gradient(135deg, rgba(57, 255, 20, 0.35), rgba(57, 255, 20, 0.12));
      box-shadow: 0 0 26px rgba(57, 255, 20, 0.45);
      outline: none;
    }

    @media (max-width: 480px) {
      .wallet-modal-content {
        padding: 26px 18px 30px;
        border-radius: 22px;
      }

      .wallet-btn {
        font-size: 1rem;
        padding: 16px 20px;
      }
    }
  </style>

  <!-- Web3Modal + WalletConnect + Ethers via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.9.2/dist/index.umd.min.js"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>

<body>
  <div class="bitcoin-rain" aria-hidden="true">
    <span style="--i:0; --x:5;"></span>
    <span style="--i:1; --x:18;"></span>
    <span style="--i:2; --x:32;"></span>
    <span style="--i:3; --x:46;"></span>
    <span style="--i:4; --x:58;"></span>
    <span style="--i:5; --x:72;"></span>
    <span style="--i:6; --x:85;"></span>
    <span style="--i:7; --x:12;"></span>
    <span style="--i:8; --x:27;"></span>
    <span style="--i:9; --x:41;"></span>
    <span style="--i:10; --x:54;"></span>
    <span style="--i:11; --x:68;"></span>
    <span style="--i:12; --x:81;"></span>
    <span style="--i:13; --x:94;"></span>
    <span style="--i:14; --x:3;"></span>
    <span style="--i:15; --x:24;"></span>
    <span style="--i:16; --x:63;"></span>
    <span style="--i:17; --x:77;"></span>
    <span style="--i:18; --x:50;"></span>
    <span style="--i:19; --x:37;"></span>
  </div>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="header-title">VaultTracker</div>
        <div class="header-subtitle">Level 1: Build a $1,000 emergency reserve.</div>
      </div>

      <div class="header-right">
        <div class="wallet-row">
          <div class="wallet-label">Wallet</div>
          <div class="wallet-address" id="walletAddress">Not connected</div>
          <div class="wallet-balance" id="walletBalance">Balance: —</div>
          <div class="network-status" id="networkStatus">Network: —</div>
        </div>
        <div class="wallet-actions">
          <button id="connectWalletBtn" class="button-outline">Connect Wallet</button>
        </div>
      </div>
    </header>

    <main class="card">
      <div class="stat-row">
        <div>
          <div class="stat-label">Total Saved</div>
          <div class="stat-value" id="totalSaved">$0.00</div>
        </div>
        <div>
          <div class="stat-label">XP</div>
          <div class="stat-value" id="xpValue">0 / 100</div>
        </div>
        <div>
          <div class="stat-label">Rank</div>
          <div class="stat-value" id="rankLabel">Recruit</div>
        </div>
      </div>

      <div class="rank-menu">
        <button
          id="rankMenuBtn"
          type="button"
          class="button-outline rank-menu-button"
          aria-haspopup="true"
          aria-expanded="false"
        >
          Rank Intel
        </button>
        <div id="rankMenuOptions" class="rank-menu-options" role="menu" aria-hidden="true">
          <div
            class="rank-menu-option"
            data-rank="Recruit"
            role="menuitem"
          >
            <span>Recruit</span>
            Build the first $1,000 emergency fund with this quick guide.
          </div>
          <div
            class="rank-menu-option"
            data-rank="Operator"
            role="menuitem"
          >
            <span>Operator</span>
            Automate transfers and keep the momentum without extra effort.
          </div>
          <div
            class="rank-menu-option"
            data-rank="Specialist"
            role="menuitem"
          >
            <span>Specialist</span>
            Set layered savings goals to stay ahead of mission needs.
          </div>
          <div
            class="rank-menu-option"
            data-rank="Commander"
            role="menuitem"
          >
            <span>Commander</span>
            Coordinate long-term capital plans once the base is secure.
          </div>
          <div
            class="rank-menu-option"
            data-rank="Legend"
            role="menuitem"
          >
            <span>Legend</span>
            Draft an investment policy to command wealth like a pro.
          </div>
        </div>
      </div>

      <div class="progress-wrapper">
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-labels">
          <span id="percentLabel">0%</span>
          <span>Goal: $1,000</span>
        </div>
      </div>

      <section class="milestones">
        <div class="milestones-title">Milestones</div>
        <ul class="milestone-list">
          <li class="milestone-item" data-amount="100">
            <span class="check">•</span> $100 – Checkpoint 1
          </li>
          <li class="milestone-item" data-amount="250">
            <span class="check">•</span> $250 – Checkpoint 2
          </li>
          <li class="milestone-item" data-amount="500">
            <span class="check">•</span> $500 – Halfway Point
          </li>
          <li class="milestone-item" data-amount="750">
            <span class="check">•</span> $750 – Checkpoint 3
          </li>
          <li class="milestone-item" data-amount="1000">
            <span class="check">•</span> $1,000 – Level Complete
          </li>
        </ul>
      </section>
      <p class="hint">
        Total Saved is synced to your connected wallet balance. Your rank is based on wallet value.
      </p>
    </main>

    <section id="leaderboardSection" class="leaderboard-section">
      <div class="leaderboard-header">
        <h2>Wallet Leaderboard</h2>
        <p>Compare wallets by on-chain balance. Your wallet is highlighted.</p>
      </div>
      <div class="leaderboard-controls">
        <input
          type="text"
          id="leaderboardWalletInput"
          placeholder="Paste wallet address (0x...)"
        />
        <button id="leaderboardAddBtn">Add Wallet</button>
        <button id="leaderboardRefreshBtn">Refresh Balances</button>
      </div>
      <div class="leaderboard-table-wrapper">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Wallet</th>
              <th>Balance</th>
              <th>Rank</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </section>

    <section id="cryptoChartSection" class="chart-section">
      <div class="tradingview-widget-container">
        <div id="tradingview_chart"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
        <script type="text/javascript">
          new TradingView.widget({
            "width": "100%",
            "height": 500,
            "symbol": "BINANCE:ETHBTC",
            "interval": "60",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#000000",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "container_id": "tradingview_chart"
          });
        </script>
      </div>
    </section>

    <section class="ai-section" id="cryptoIntel">
      <div class="ai-header">
        <h2 class="ai-title">Crypto Intel Console</h2>
        <p class="ai-description">
          Ask about digital assets, blockchains, and market tactics. The assistant responds with vetted facts and
          balanced guidance while reminding you that every move carries risk. Always cross-check critical decisions.
        </p>
        <div class="ai-meta" aria-live="polite">Last updated: 1 December 2025</div>
      </div>

      <div class="ai-chat-panel">
        <div class="ai-messages" id="aiMessages" role="log" aria-live="polite" aria-label="Conversation log"></div>
        <form class="ai-form" id="aiForm" autocomplete="off">
          <label for="aiInput" class="sr-only">Ask about crypto</label>
          <input type="text" id="aiInput" class="ai-input" name="prompt" placeholder="Ask about Bitcoin, staking, regulation, strategy…" required />
          <button type="submit" class="ai-submit" id="aiSubmit">Send</button>
        </form>
      </div>

      <p class="ai-hint">
        Guidance is educational only. Markets change fast, so confirm numbers independently and consider consulting a
        licensed professional before acting.
      </p>
    </section>

    <footer class="footer">
      Built to hack dopamine, not just dollars. Stay on mission.
    </footer>
  </div>

  <script>
    /************* CRYPTO INTEL ASSISTANT *************/
    const aiKnowledgeBase = [
      {
        topic: "bitcoin",
        keywords: ["bitcoin", "btc", "satoshi", "halving", "digital gold"],
        facts: [
          "Bitcoin runs on proof-of-work mining with issuance capped at 21 million coins, keeping long-term supply predictable.",
          "The most recent halving on 19 April 2024 reduced block rewards to 3.125 BTC, so new supply now grows more slowly."
        ],
        guidance:
          "Track network congestion before moving BTC; batching transactions or tapping Lightning can help manage fees during busy windows."
      },
      {
        topic: "ethereum",
        keywords: ["ethereum", "eth", "stak", "l2", "rollup", "evm"],
        facts: [
          "Ethereum has used proof-of-stake since the Merge in September 2022, letting validators secure the chain with staked ETH instead of miners.",
          "Layer-2 rollups settle back to Ethereum mainnet, so gas demand and security ultimately tie into the base chain."
        ],
        guidance:
          "Compare staking yields after protocol upgrades and factor in withdrawal queues or slashing rules before delegating ETH."
      },
      {
        topic: "stablecoins",
        keywords: ["stablecoin", "usdc", "usdt", "peg", "stable"],
        facts: [
          "Reserve-backed stablecoins such as USDC and USDT aim to stay near $1.00 by holding short-term treasuries and cash equivalents.",
          "Algorithmic or undercollateralized designs have a history of breaking their pegs under stress, so collateral transparency matters."
        ],
        guidance:
          "Diversify issuers, read attestation reports, and confirm which chains a stablecoin natively supports before parking large balances."
      },
      {
        topic: "defi",
        keywords: ["defi", "yield", "liquidity", "amm", "dex", "lend", "borrow"],
        facts: [
          "DeFi protocols route swaps through automated market makers that rely on liquidity pools supplied by depositors.",
          "Smart-contract exploits and governance takeovers remain common, even on audited protocols, so due diligence never stops."
        ],
        guidance:
          "Limit approvals, monitor protocol treasuries, and size positions assuming temporary loss or pauses can happen without warning."
      },
      {
        topic: "security",
        keywords: ["security", "hardware", "seed", "wallet", "ledger", "trezor", "phishing"],
        facts: [
          "Hardware wallets keep private keys offline, shrinking the attack surface for malware and phishing links.",
          "Most retail breaches stem from reused passwords or signing malicious transactions, not direct blockchain failures."
        ],
        guidance:
          "Store seed phrases in multiple secure formats, enable multi-factor auth, and review transaction details carefully before signing."
      },
      {
        topic: "regulation",
        keywords: ["regulation", "irs", "tax", "sec", "compliance", "rules"],
        facts: [
          "In the United States, the IRS treats cryptocurrencies as property, so selling, swapping, or spending triggers capital-gains reporting.",
          "Regulators focus on KYC/AML controls for custodial platforms, and enforcement actions can freeze or delist assets quickly."
        ],
        guidance:
          "Keep organized trade logs, monitor IRS guidance, and confirm exchange licensing in your state before onboarding capital."
      },
      {
        topic: "portfolio",
        keywords: ["portfolio", "allocate", "risk", "diversify", "rebalance", "strategy", "invest"],
        facts: [
          "Crypto assets routinely post annualized volatility above 70%, far higher than traditional equity benchmarks.",
          "Liquidity and network effects concentrate returns in a small set of assets each cycle, so concentration risk is real."
        ],
        guidance:
          "Define allocation bands, rebalance on a schedule, and align exposure with your time horizon and drawdown tolerance."
      }
    ];

    const aiFallbacks = [
      "Crypto markets move around the clock, so combine on-chain metrics, liquidity depth, and macro headlines before reacting.",
      "When research can’t answer your question, start with primary sources like whitepapers, audited financials, and regulatory filings.",
      "Focus on product-market fit, funding runway, and real user traction before trusting any crypto narrative."
    ];

    const aiSafetyNotes = [
      "This console shares education only. Independently verify numbers and consider qualified financial, legal, or tax counsel before acting.",
      "Never risk funds you cannot afford to lock up or lose. Double-check contract addresses and URLs before connecting wallets.",
      "Maintain diversified custody plans, keep emergency liquidity off-exchange, and update your security hygiene regularly."
    ];

    const aiActionCues = ["should i", "buy", "sell", "invest", "trade", "hold", "short", "leverage"];

    let aiMessagesEl;
    let aiFormEl;
    let aiInputEl;
    let aiSubmitEl;
    let aiExchangeCount = 0;

    function appendAIMessage(text, sender = "agent") {
      if (!aiMessagesEl) return;
      const messageEl = document.createElement("div");
      messageEl.classList.add("ai-message");
      if (sender === "user") {
        messageEl.classList.add("user");
      }
      messageEl.textContent = text.trim();
      aiMessagesEl.appendChild(messageEl);
      aiMessagesEl.scrollTop = aiMessagesEl.scrollHeight;
    }

    function scoreKnowledgeEntry(normalizedText, entry) {
      return entry.keywords.reduce((score, keyword) => {
        return score + (normalizedText.includes(keyword) ? 1 : 0);
      }, 0);
    }

    function buildResponseFromEntry(entry, normalizedText) {
      const actionDetected = aiActionCues.some((cue) => normalizedText.includes(cue));
      const facts = entry.facts.join("\n\n");
      let response = `${facts}\n\n${entry.guidance}`;
      if (actionDetected) {
        response += "\n\nConsider scenario planning and position sizing before executing any orders.";
      }
      return response;
    }

    function generateAIResponse(userText) {
      const normalized = userText.toLowerCase();
      let bestEntry = null;
      let bestScore = 0;

      for (const entry of aiKnowledgeBase) {
        const score = scoreKnowledgeEntry(normalized, entry);
        if (score > bestScore) {
          bestScore = score;
          bestEntry = entry;
        }
      }

      let response;
      if (bestEntry && bestScore > 0) {
        response = buildResponseFromEntry(bestEntry, normalized);
      } else {
        const fallback = aiFallbacks[aiExchangeCount % aiFallbacks.length];
        const actionDetected = aiActionCues.some((cue) => normalized.includes(cue));
        response = fallback;
        if (actionDetected) {
          response += "\n\nMap out upside, downside, and exit triggers before committing capital.";
        }
      }

      const safetyTail = aiSafetyNotes[aiExchangeCount % aiSafetyNotes.length];
      aiExchangeCount += 1;

      return `${response}\n\n${safetyTail}`;
    }

    function setupCryptoIntel() {
      aiMessagesEl = document.getElementById("aiMessages");
      aiFormEl = document.getElementById("aiForm");
      aiInputEl = document.getElementById("aiInput");
      aiSubmitEl = document.getElementById("aiSubmit");

      if (!aiMessagesEl || !aiFormEl || !aiInputEl || !aiSubmitEl) {
        return;
      }

      appendAIMessage(
        "Crypto Intel Console online. Data horizon: 1 December 2025. Ask for facts, market structure, or risk frameworks to receive balanced guidance.",
        "agent"
      );

      aiFormEl.addEventListener("submit", (event) => {
        event.preventDefault();
        const userInput = aiInputEl.value.trim();
        if (!userInput) {
          return;
        }

        appendAIMessage(userInput, "user");
        aiInputEl.value = "";
        aiInputEl.focus();
        aiSubmitEl.disabled = true;

        window.setTimeout(() => {
          try {
            const response = generateAIResponse(userInput);
            appendAIMessage(response, "agent");
          } catch (error) {
            console.error("Crypto Intel error:", error);
            appendAIMessage("Intel module encountered an unexpected issue. Refresh the page and try again.", "agent");
          } finally {
            aiSubmitEl.disabled = false;
            aiInputEl.focus();
          }
        }, 360);
      });
    }

    /************* SAVINGS TRACKER LOGIC *************/
    const GOAL = 1000;
    const STORAGE_KEY = "dopamine_savings_total";

    let total = 0;

    function loadSavedTotal() {
      const stored = localStorage.getItem(STORAGE_KEY);
      total = stored ? parseFloat(stored) : 0;
      if (isNaN(total)) total = 0;
      updateUI();
    }

    function saveTotal() {
      localStorage.setItem(STORAGE_KEY, String(total.toFixed(2)));
    }

    function formatCurrency(value) {
      return "$" + value.toFixed(2);
    }

    function getRank(total) {
      if (total >= 50000) return "Legend";
      if (total >= 10000) return "Commander";
      if (total >= 5000) return "Specialist";
      if (total >= 1000) return "Operator";
      return "Recruit";
    }

    function updateUI() {
      const totalEl = document.getElementById("totalSaved");
      const xpEl = document.getElementById("xpValue");
      const progressFill = document.getElementById("progressFill");
      const percentLabel = document.getElementById("percentLabel");
      const milestones = document.querySelectorAll(".milestone-item");
      const rankLabelEl = document.getElementById("rankLabel");

      totalEl.textContent = formatCurrency(total);

      const rank = getRank(total);

      if (rankLabelEl) {
        rankLabelEl.textContent = rank;
      }

      if (rankMenuOptions) {
        const options = rankMenuOptions.querySelectorAll("[data-rank]");
        options.forEach((option) => {
          if (option.getAttribute("data-rank") === rank) {
            option.classList.add("active");
          } else {
            option.classList.remove("active");
          }
        });
      }

      const xp = Math.floor(total / 10); // $10 = 1 XP
      const xpClamped = xp > 100 ? 100 : xp;
      xpEl.textContent = xpClamped + " / 100";

      const percent = Math.min((total / GOAL) * 100, 100);
      progressFill.style.width = percent + "%";
      percentLabel.textContent = Math.floor(percent) + "%";

      milestones.forEach((item) => {
        const amount = parseFloat(item.getAttribute("data-amount"));
        if (total >= amount) {
          item.classList.add("complete");
          item.querySelector(".check").textContent = "✓";
        } else {
          item.classList.remove("complete");
          item.querySelector(".check").textContent = "•";
        }
      });
    }

    /************* WALLET CONNECTION *************/
    const metadataUrl = window.location.origin;

    let walletConnectProvider;
    let activeProvider = null;
    let web3Provider;   // ethers.js Web3Provider
    let signer;
    let currentAccount = null;
    let connectedChainId = null;

    // Wallet leaderboard state
    let trackedWallets = []; // array of { address: string }

    const NETWORK_NAMES = {
      1: { name: "Ethereum Mainnet", symbol: "ETH" },
      137: { name: "Polygon Mainnet", symbol: "MATIC" },
      56: { name: "BNB Smart Chain", symbol: "BNB" }
    };

    let walletAddressEl;
    let walletBalanceEl;
    let networkStatusEl;
    let connectWalletBtn;
    let rankMenuBtn;
    let rankMenuOptions;

    function shortenAddress(addr) {
      if (!addr) return "";
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    function parseChainId(raw) {
      if (raw === null || typeof raw === "undefined") {
        return null;
      }
      if (typeof raw === "number") {
        return raw;
      }
      if (typeof raw === "string") {
        if (raw.startsWith("0x") || raw.startsWith("0X")) {
          return parseInt(raw, 16);
        }
        const segments = raw.split(":");
        const candidate = segments.length >= 2 ? segments[1] : segments[0];
        const parsed = parseInt(candidate, 10);
        return Number.isNaN(parsed) ? null : parsed;
      }
      return null;
    }

    function updateConnectionButtonLabel() {
      if (!connectWalletBtn) return;
      if (currentAccount) {
        connectWalletBtn.textContent = `Connected: ${shortenAddress(currentAccount)}`;
        connectWalletBtn.classList.add("connected");
      } else {
        connectWalletBtn.textContent = "Connect Wallet";
        connectWalletBtn.classList.remove("connected");
      }
    }

    async function getWalletConnectProvider() {
      if (walletConnectProvider) {
        return walletConnectProvider;
      }

      const providerModule = window["@walletconnect/ethereum-provider"];
      const ProviderCtor =
        providerModule?.default ||
        providerModule?.EthereumProvider ||
        window.WalletConnectProvider?.default ||
        window.WalletConnectProvider;

      if (!ProviderCtor) {
        console.error("WalletConnect provider library is unavailable.");
        return null;
      }

      const metadataIconUrl = `${metadataUrl.replace(/\/$/, "")}/icon.png`;

      try {
        if (typeof ProviderCtor.init === "function") {
          walletConnectProvider = await ProviderCtor.init({
            projectId: "demo",
            relayUrl: "wss://relay.walletconnect.com",
            metadata: {
              name: "VaultTracker",
              description: "Mobile-friendly wallet connection",
              url: metadataUrl,
              icons: [metadataIconUrl]
            },
            chains: [1],
            showQrModal: true
          });
        } else {
          walletConnectProvider = new ProviderCtor({
            projectId: "demo",
            relayUrl: "wss://relay.walletconnect.com",
            metadata: {
              name: "VaultTracker",
              description: "Mobile-friendly wallet connection",
              url: metadataUrl,
              icons: [metadataIconUrl]
            },
            showQrModal: true,
            chainId: 1
          });
        }

        return walletConnectProvider;
      } catch (err) {
        console.error("Failed to initialize WalletConnect provider:", err);
        return null;
      }
    }

    function attachProviderEvents(provider) {
      if (activeProvider && activeProvider !== provider && typeof activeProvider.removeListener === "function") {
        activeProvider.removeListener("accountsChanged", handleAccountsChanged);
        activeProvider.removeListener("chainChanged", handleChainChanged);
        activeProvider.removeListener("disconnect", handleDisconnect);
      }

      if (!provider || typeof provider.on !== "function") {
        activeProvider = provider || null;
        return;
      }

      if (typeof provider.removeListener === "function") {
        provider.removeListener("accountsChanged", handleAccountsChanged);
        provider.removeListener("chainChanged", handleChainChanged);
        provider.removeListener("disconnect", handleDisconnect);
      }

      provider.on("accountsChanged", handleAccountsChanged);
      provider.on("chainChanged", handleChainChanged);
      provider.on("disconnect", handleDisconnect);

      activeProvider = provider;
    }

    async function handleAccountsChanged(accounts) {
      if (!accounts || accounts.length === 0) {
        handleDisconnect();
        return;
      }

      currentAccount = accounts[0];
      walletAddressEl.textContent = shortenAddress(currentAccount);
      updateConnectionButtonLabel();
      ensureTrackedWallet(currentAccount);
      await refreshNetworkAndBalance();
    }

    async function handleChainChanged(chainId) {
      const parsed = parseChainId(chainId);
      if (parsed !== null) {
        connectedChainId = parsed;
      }
      await refreshNetworkAndBalance();
    }

    function handleDisconnect() {
      currentAccount = null;
      connectedChainId = null;
      signer = null;
      web3Provider = null;
      walletAddressEl.textContent = "Not connected";
      walletBalanceEl.textContent = "Balance: —";
      networkStatusEl.textContent = "Network: —";
      networkStatusEl.className = "network-status";
      updateConnectionButtonLabel();
      total = 0;
      saveTotal();
      updateUI();
      refreshLeaderboard();
    }

    async function connectDesktopWallet() {
      if (!window.ethereum) {
        alert("No injected wallet detected. Please install a browser wallet or use a mobile wallet.");
        return;
      }

      const provider = window.ethereum;

      try {
        const accounts = await provider.request({ method: "eth_requestAccounts" });
        let chainIdRaw = null;
        try {
          chainIdRaw = await provider.request({ method: "eth_chainId" });
        } catch (chainErr) {
          console.warn("Unable to read chainId from injected provider via request:", chainErr);
          chainIdRaw = provider.chainId;
        }
        connectedChainId = parseChainId(chainIdRaw);
        web3Provider = new ethers.providers.Web3Provider(provider);
        signer = web3Provider.getSigner();
        await handleAccountsChanged(accounts);
        attachProviderEvents(provider);
      } catch (err) {
        console.error("Injected wallet connect error:", err);
        alert("Wallet connection cancelled or failed.");
      }
    }

    async function connectWithWalletConnect() {
      try {
        const provider = await getWalletConnectProvider();
        if (!provider) {
          alert("WalletConnect is unavailable right now. Please try again later.");
          return;
        }

        if (!Array.isArray(provider.accounts) || provider.accounts.length === 0) {
          if (typeof provider.enable === "function") {
            await provider.enable();
          } else if (typeof provider.connect === "function") {
            await provider.connect();
          }
        }

        let accounts = Array.isArray(provider.accounts) ? [...provider.accounts] : [];
        if ((!accounts || accounts.length === 0) && provider.session?.namespaces?.eip155?.accounts) {
          accounts = provider.session.namespaces.eip155.accounts.map((entry) => {
            const parts = entry.split(":");
            return parts[parts.length - 1];
          });
        }
        accounts = accounts.map((entry) => {
          if (typeof entry !== "string") return entry;
          if (entry.includes(":")) {
            const parts = entry.split(":");
            return parts[parts.length - 1];
          }
          return entry;
        });
        let parsedChainId = parseChainId(provider.chainId);
        if (parsedChainId === null && provider.session?.namespaces?.eip155?.chains?.length) {
          parsedChainId = parseChainId(provider.session.namespaces.eip155.chains[0]);
        }
        if (parsedChainId !== null) {
          connectedChainId = parsedChainId;
        }

        if (!accounts || accounts.length === 0) {
          alert("WalletConnect did not return any accounts. Please try again.");
          return;
        }

        web3Provider = new ethers.providers.Web3Provider(provider);
        signer = web3Provider.getSigner();
        attachProviderEvents(provider);
        await handleAccountsChanged(accounts);
      } catch (err) {
        console.error("WalletConnect connection error:", err);
        alert("WalletConnect connection cancelled or failed.");
      }
    }

    async function connectWallet() {
      if (window.ethereum) {
        await connectDesktopWallet();
        return;
      }

      await connectWithWalletConnect();
    }

    async function refreshNetworkAndBalance() {
      await updateNetworkInfo();
      await updateBalance();
    }

    async function updateNetworkInfo() {
      if (!web3Provider) {
        networkStatusEl.textContent = "Network: —";
        networkStatusEl.className = "network-status";
        return;
      }

      try {
        const network = await web3Provider.getNetwork();
        connectedChainId = network?.chainId ?? connectedChainId;
        const cfg = NETWORK_NAMES[network.chainId] || { name: `Chain ${network.chainId}`, symbol: "ETH" };

        networkStatusEl.textContent = `Network: ${cfg.name}`;
        networkStatusEl.className = "network-status ok";
      } catch (err) {
        console.error("Error reading network:", err);
        networkStatusEl.textContent = "Network: Error";
        networkStatusEl.className = "network-status warn";
      }
    }

    async function updateBalance() {
      if (!web3Provider || !currentAccount) {
        walletBalanceEl.textContent = "Balance: —";
        total = 0;
        saveTotal();
        updateUI();
        refreshLeaderboard();
        connectedChainId = null;
        return;
      }

      ensureTrackedWallet(currentAccount);

      try {
        const network = await web3Provider.getNetwork();
        connectedChainId = network?.chainId ?? connectedChainId;
        const cfg = NETWORK_NAMES[network.chainId] || { symbol: "ETH" };
        const balanceWei = await web3Provider.getBalance(currentAccount);
        const balance = ethers.utils.formatEther(balanceWei);
        walletBalanceEl.textContent = `Balance: ${Number(balance).toFixed(4)} ${cfg.symbol}`;

        const balanceNumber = Number(balance);
        if (!isNaN(balanceNumber)) {
          total = balanceNumber;
          saveTotal();
          updateUI();
          refreshLeaderboard();
        }
      } catch (err) {
        console.error("Error reading balance:", err);
        walletBalanceEl.textContent = "Balance: Error";
      }
    }

    function ensureTrackedWallet(address) {
      if (!address) {
        return;
      }

      const normalized = address.toLowerCase();
      const exists = trackedWallets.some((item) => item.address.toLowerCase() === normalized);
      if (!exists) {
        trackedWallets.push({ address });
      }
    }

    async function refreshLeaderboard() {
      const tbody = document.getElementById("leaderboardBody");
      if (!tbody) return;

      tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

      try {
        if (typeof ethers === "undefined" || !ethers.providers || !ethers.utils) {
          tbody.innerHTML = "<tr><td colspan='4'>Ethers.js unavailable.</td></tr>";
          return;
        }

        let provider = web3Provider;
        if (!provider) {
          provider = new ethers.providers.JsonRpcProvider("https://cloudflare-eth.com");
        }

        const results = [];
        for (const item of trackedWallets) {
          if (!item || !item.address) {
            continue;
          }

          try {
            const balanceWei = await provider.getBalance(item.address);
            const balanceEth = Number(ethers.utils.formatEther(balanceWei));
            results.push({
              address: item.address,
              balance: balanceEth
            });
          } catch (err) {
            console.error("Error fetching balance for", item.address, err);
          }
        }

        results.sort((a, b) => b.balance - a.balance);

        tbody.innerHTML = "";
        results.forEach((entry, idx) => {
          const tr = document.createElement("tr");
          if (currentAccount && entry.address.toLowerCase() === currentAccount.toLowerCase()) {
            tr.classList.add("leaderboard-row-self");
          }
          const rankName = typeof getRank === "function" ? getRank(entry.balance) : "Recruit";
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${shortenAddress(entry.address)}</td>
            <td>${entry.balance.toFixed(4)} ETH</td>
            <td><span class="leaderboard-rank-badge">${rankName}</span></td>
          `.trim();
          tbody.appendChild(tr);
        });

        if (results.length === 0) {
          tbody.innerHTML = "<tr><td colspan='4'>No wallets tracked yet.</td></tr>";
        }
      } catch (err) {
        console.error("Error refreshing leaderboard:", err);
        tbody.innerHTML = "<tr><td colspan='4'>Error loading leaderboard.</td></tr>";
      }
    }

    function addWalletToLeaderboard() {
      const input = document.getElementById("leaderboardWalletInput");
      if (!input) return;
      const raw = (input.value || "").trim();
      if (!raw) return;

      if (!/^0x[a-fA-F0-9]{40}$/.test(raw)) {
        alert("Please enter a valid 0x wallet address.");
        return;
      }

      ensureTrackedWallet(raw);

      input.value = "";
      refreshLeaderboard();
    }

    document.addEventListener("DOMContentLoaded", () => {
      walletAddressEl = document.getElementById("walletAddress");
      walletBalanceEl = document.getElementById("walletBalance");
      networkStatusEl = document.getElementById("networkStatus");
      connectWalletBtn = document.getElementById("connectWalletBtn");
      rankMenuBtn = document.getElementById("rankMenuBtn");
      rankMenuOptions = document.getElementById("rankMenuOptions");
      const leaderboardAddBtn = document.getElementById("leaderboardAddBtn");
      const leaderboardRefreshBtn = document.getElementById("leaderboardRefreshBtn");
      const leaderboardWalletInput = document.getElementById("leaderboardWalletInput");

      setupCryptoIntel();

      if (!window.ethers) {
        alert("Ethers.js failed to load. Check your connection and reload.");
      }

      if (connectWalletBtn) {
        connectWalletBtn.addEventListener("click", connectWallet);
        updateConnectionButtonLabel();
      }

      if (window.ethereum && window.ethereum.selectedAddress) {
        // Surface already-connected injected wallets without prompting again.
        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = web3Provider.getSigner();
        connectedChainId = parseChainId(window.ethereum.chainId);
        handleAccountsChanged([window.ethereum.selectedAddress]).catch((err) => {
          console.error("Failed to hydrate existing wallet connection:", err);
        });
        attachProviderEvents(window.ethereum);
      }

      if (leaderboardAddBtn) {
        leaderboardAddBtn.addEventListener("click", addWalletToLeaderboard);
      }

      if (leaderboardRefreshBtn) {
        leaderboardRefreshBtn.addEventListener("click", refreshLeaderboard);
      }

      if (leaderboardWalletInput) {
        leaderboardWalletInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            addWalletToLeaderboard();
          }
        });
      }

      if (rankMenuBtn && rankMenuOptions) {
        const closeRankMenu = () => {
          if (!rankMenuOptions.classList.contains("open")) return;
          rankMenuOptions.classList.remove("open");
          rankMenuBtn.setAttribute("aria-expanded", "false");
          rankMenuOptions.setAttribute("aria-hidden", "true");
        };

        rankMenuBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          const isOpen = rankMenuOptions.classList.toggle("open");
          rankMenuBtn.setAttribute("aria-expanded", String(isOpen));
          rankMenuOptions.setAttribute("aria-hidden", String(!isOpen));
        });

        rankMenuOptions.addEventListener("click", (event) => {
          event.stopPropagation();
        });

        document.addEventListener("click", () => {
          closeRankMenu();
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            closeRankMenu();
          }
        });
      }

      loadSavedTotal();
      if (currentAccount) {
        ensureTrackedWallet(currentAccount);
      }
      refreshLeaderboard();
    });
  </script>
</body>
</html>
